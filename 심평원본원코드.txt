LIBNAME TH 'D:\HIRA\EDU\TRAINING';

/* Project */
%MACRO MAIN_ASCT_CNT(M_CD,M_CD_STR);
PROC SQL;
/* J20 PATIENTS AND 90DAY BEFORE AFTER **/
CREATE TABLE WORK.&M_CD._SPEC_TEMP AS
SELECT A.MID, A.MAIN_SICK, A.JID, MIN(RECU_FR_DD) AS FIRSTT
FROM TH.T200_2019S3_01 A
WHERE SUBSTR(A.MAIN_SICK,1,3) = &M_CD_STR
GROUP BY JID
;QUIT;


PROC SQL;
/* J20 PATIENTS AND 90DAY BEFORE AFTER **/
CREATE TABLE WORK.&M_CD._SPEC AS
SELECT A.*
FROM WORK.&M_CD._SPEC_TEMP A
WHERE SUBSTR(A.MAIN_SICK,1,3) = &M_CD_STR
AND FIRSTT < '20171231' AND FIRSTT > '20160101'   /*바뀐부분임*/
GROUP BY JID
;QUIT;

PROC SQL;
/* ALL OF DATA JID */
CREATE TABLE WORK.&M_CD._ALL AS
SELECT DISTINCT A.JID, B.MID, B.RECU_FR_DD, B.MAIN_SICK, A.FIRSTT
FROM WORK.&M_CD._SPEC A
LEFT JOIN TH.T200_2019S3_01 B ON A.JID = B.JID
ORDER BY A.JID, B.RECU_FR_DD ASC
;QUIT;

/*형변환 추가*/
PROC SQL;
CREATE TABLE WORK.&M_CD._ALL_NUM AS
SELECT JID, MID, input(RECU_FR_DD, yymmdd10.) AS RECU_FR_DD, input(FIRSTT, yymmdd10.) AS FIRSTT
FROM WORK.&M_CD._ALL;
QUIT;


PROC SQL;
/* +-90days SPEC data */
CREATE TABLE WORK.&M_CD._3M AS
SELECT DISTINCT A.JID, A.MID, A.RECU_FR_DD, A.FIRSTT
FROM WORK.&M_CD._ALL_NUM A
WHERE INTCK('day', FIRSTT, RECU_FR_DD) < 365 
AND INTCK('day', FIRSTT, RECU_FR_DD)  >= -365 /*바뀐부분임*/
GROUP BY A.JID
ORDER BY A.JID, A.RECU_FR_DD ASC
;QUIT;

PROC SQL;
/* +-90DAYS SICK DATA */
CREATE TABLE &M_CD._SICK AS
SELECT DISTINCT A.JID, B.SICK_CD, A.MID, A.RECU_FR_DD, A.FIRSTT
FROM WORK.&M_CD._3M A
LEFT JOIN TH.T400_2019S3_01 B ON A.MID = B.MID
ORDER BY A.JID, A.RECU_FR_DD ASC
;QUIT;

PROC SQL;
/* +-90DAYS SICK DATA */
CREATE TABLE &M_CD._DIS_SICK AS
SELECT DISTINCT A.JID, A.SICK_CD
FROM WORK.&M_CD._SICK A
group by A.JID
ORDER BY A.JID ASC
;QUIT;

PROC SQL;
CREATE TABLE &M_CD._ASCT_CNT AS 
SELECT DISTINCT SICK_CD, COUNT(SICK_CD) AS CNT
FROM &M_CD._DIS_SICK
GROUP BY SICK_CD
ORDER BY CNT DESC;
QUIT;

PROC SQL;
/* COUNT SICK */
CREATE TABLE &M_CD._SICK1 AS
SELECT A.SICK_CD, COUNT(A.SICK_CD) AS NUM_SICK
FROM &M_CD._SICK A
GROUP BY A.SICK_CD
ORDER BY NUM_SICK DESC
;QUIT;

/* ----------VISUALIZING---------- */
DATA ALL_DAY; 
DO DAY = -365 TO 365; /*바뀐부분임*/
OUTPUT;
END;
RUN;

/* ADD RANK COLUMN */
DATA RANK_SICK; 
SET &M_CD._ASCT_CNT;
RANK_SICK+1;
RUN;

/* RANK1 */

PROC SQL;
SELECT SICK_CD
INTO : RANK1
FROM RANK_SICK
WHERE RANK_SICK = 1
;QUIT;

PROC SQL;
CREATE TABLE RANK1_DAY_DIS AS
SELECT DISTINCT A.JID, A.MID, INTCK('day' , FIRSTT, RECU_FR_DD) AS DIS_DAY
FROM &M_CD._SICK A
WHERE A.SICK_CD IN (SELECT SICK_CD FROM RANK_SICK WHERE RANK_SICK = 1)
GROUP BY A.JID
ORDER BY A.RECU_FR_DD ASC
;QUIT;

/* RANK2 */
PROC SQL;
SELECT SICK_CD
INTO : RANK2
FROM RANK_SICK
WHERE RANK_SICK = 2
;QUIT;

PROC SQL;
CREATE TABLE RANK2_DAY_DIS AS
SELECT DISTINCT A.JID, A.MID, INTCK('day' , FIRSTT, RECU_FR_DD) AS DIS_DAY
FROM &M_CD._SICK A
WHERE A.SICK_CD IN (SELECT SICK_CD FROM RANK_SICK WHERE RANK_SICK = 2)
GROUP BY A.JID
ORDER BY A.RECU_FR_DD ASC
;QUIT;

/* RANK3 */
PROC SQL;
SELECT SICK_CD
INTO : RANK3
FROM RANK_SICK
WHERE RANK_SICK = 3
;QUIT;

PROC SQL;
CREATE TABLE RANK3_DAY_DIS AS
SELECT DISTINCT A.JID, A.MID, INTCK('day' , FIRSTT, RECU_FR_DD) AS DIS_DAY
FROM &M_CD._SICK A
WHERE A.SICK_CD IN (SELECT SICK_CD FROM RANK_SICK WHERE RANK_SICK = 3)
GROUP BY A.JID
ORDER BY A.RECU_FR_DD ASC
;QUIT;

PROC SQL;
CREATE TABLE RANK1_FIGURE AS
SELECT A.DAY, COUNT(B.DIS_DAY) AS CNT
FROM ALL_DAY A
LEFT JOIN RANK1_DAY_DIS B ON A.DAY = B.DIS_DAY
GROUP BY A.DAY
ORDER BY A.DAY ASC
;QUIT;

PROC SQL;
CREATE TABLE RANK2_FIGURE AS
SELECT A.DAY, COUNT(B.DIS_DAY) AS CNT
FROM ALL_DAY A
LEFT JOIN RANK2_DAY_DIS B ON A.DAY = B.DIS_DAY
GROUP BY A.DAY
ORDER BY A.DAY ASC
;QUIT;

PROC SQL;
CREATE TABLE RANK3_FIGURE AS
SELECT A.DAY, COUNT(B.DIS_DAY) AS CNT
FROM ALL_DAY A
LEFT JOIN RANK3_DAY_DIS B ON A.DAY = B.DIS_DAY
GROUP BY A.DAY
ORDER BY A.DAY ASC
;QUIT;

PROC SQL;
CREATE TABLE &M_CD._FIGURE AS
SELECT A.DAY, B.CNT AS RANK1,
C.CNT AS RANK2,
D.CNT AS RANK3
FROM ALL_DAY A
LEFT JOIN RANK1_FIGURE B ON A.DAY = B.DAY
LEFT JOIN RANK2_FIGURE C ON A.DAY = C.DAY
LEFT JOIN RANK3_FIGURE D ON A.DAY = D.DAY
GROUP BY A.DAY
ORDER BY A.DAY ASC
;QUIT;

PROC SQL;
CREATE TABLE &M_CD._FIGURE1 AS
SELECT A.DAY, A.RANK1, A.RANK2, A.RANK3, ROUND(A.DAY/15) AS WEEK
FROM &M_CD._FIGURE A
ORDER BY A.DAY ASC
;QUIT;

PROC SQL;
CREATE TABLE &M_CD._FIGURE2 AS
SELECT DISTINCT A.WEEK, SUM(A.RANK1) AS &RANK1, SUM(A.RANK2) AS &RANK2, SUM(A.RANK3) AS &RANK3
FROM &M_CD._FIGURE1 A
GROUP BY A.WEEK
ORDER BY A.WEEK ASC
;QUIT;

SYMBOL1 i=join v=none h=1 l=1 c=red;
SYMBOL2 i=join v=none h=1 l=1 c=BLACK;
SYMBOL3 i=join v=none h=1 l=1 c=BLUE;

PROC GPLOT DATA = &M_CD._FIGURE2;
PLOT &RANK1*WEEK = 1 &RANK2*WEEK = 2 &RANK3*WEEK = 3/ OVERLAY LEGEND;
RUN;

/* ----------CALCULATION---------- */
PROC SQL;
/* NUM OF MSICK PATIENT */
SELECT COUNT(DISTINCT A.JID)
INTO : NUM_PAT
FROM &M_CD._DIS_SICK A
;QUIT;

PROC SQL;
/* PERCENT OF SICK */
CREATE TABLE &M_CD._PER_SICK AS
SELECT A.SICK_CD, ROUND(A.CNT/&NUM_PAT * 100, 0.01) AS PER 
FROM &M_CD._ASCT_CNT A
ORDER BY PER DESC
;QUIT;

PROC SQL;
/* NUM OF ALL PATIENT */
SELECT COUNT(DISTINCT A.JID) 
INTO : NUM_ALL
FROM TH.T200_2019S3_01 A
WHERE INPUT(A.RECU_FR_DD,YYYYMMDD.) <= 20171231
AND INPUT(A.RECU_FR_DD,YYYYMMDD.) >= 20170101
;QUIT;

PROC SQL;
/* NUM OF RANK1 PARIENT */
CREATE TABLE RANK1_NUM AS
SELECT DISTINCT A.SICK_CD, ROUND(COUNT(DISTINCT B.JID)/&NUM_ALL*100,0.01) AS PER
FROM TH.T400_2019S3_01 A
LEFT JOIN TH.T200_2019S3_01 B ON A.MID = B.MID
WHERE A.SICK_CD IN (SELECT SICK_CD FROM RANK_SICK WHERE RANK_SICK = 1)
AND INPUT(B.RECU_FR_DD,YYYYMMDD.) <= 20171231
AND INPUT(B.RECU_FR_DD,YYYYMMDD.) >= 20170101
;QUIT;

PROC SQL;
/* NUM OF RANK2 PARIENT */
CREATE TABLE RANK2_NUM AS
SELECT DISTINCT A.SICK_CD, ROUND(COUNT(DISTINCT B.JID)/&NUM_ALL*100,0.01) AS PER
FROM TH.T400_2019S3_01 A
LEFT JOIN TH.T200_2019S3_01 B ON A.MID = B.MID
WHERE A.SICK_CD IN (SELECT SICK_CD FROM RANK_SICK WHERE RANK_SICK = 2)
AND INPUT(B.RECU_FR_DD,YYYYMMDD.) <= 20171231
AND INPUT(B.RECU_FR_DD,YYYYMMDD.) >= 20170101
;QUIT;

PROC SQL;
/* NUM OF RANK3 PARIENT */
CREATE TABLE RANK3_NUM AS
SELECT DISTINCT A.SICK_CD, ROUND(COUNT(DISTINCT B.JID)/&NUM_ALL*100,0.01) AS PER
FROM TH.T400_2019S3_01 A
LEFT JOIN TH.T200_2019S3_01 B ON A.MID = B.MID
WHERE A.SICK_CD IN (SELECT SICK_CD FROM RANK_SICK WHERE RANK_SICK = 3)
AND INPUT(B.RECU_FR_DD,YYYYMMDD.) <= 20171231
AND INPUT(B.RECU_FR_DD,YYYYMMDD.) >= 20170101
;QUIT;

DATA PER_RANK;
SET 
RANK1_NUM
RANK2_NUM
RANK3_NUM;
RUN;

%MEND;

%MAIN_ASCT_CNT(I10,'I10')

PROC SQL;
CREATE TABLE 
SELECT SICK_CD
FROM TABLE
WHERE B/A% > B/ALL% AND B/A > 10

(A&B PAT / ALL PAT) * 비용

비용계산
A&B AMT
NPS200

주A 평균비용 = 10000원
주B 평균비용 = 20000원, 40% <- 5% (35%)
주C 평균비용 = 5000원, 10% <- 7% (3%)

연관 상병 고려한 1년 평균 비용 = 주A 평균비용 + 주B 평균비용*(발생확률-원래 B발생확률) + 주C 평균비용*(발생확률-원래 C발생확률)

보험사
10000원 + 2000원 + 150원 = 15000원